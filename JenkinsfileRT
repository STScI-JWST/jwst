// [skip ci] and [ci skip] have no effect here.
if (utils.scm_checkout(['skip_disable':true])) return

jobconfig = new JobConfig()
jobconfig.enable_env_publication = true
jobconfig.publish_env_on_success_only = true

// Define python and numpy versions
python_version = '3.6'
numpy_version = '1.16.*'

// Define environment variables needed for the tests
def test_env = [
    "HOME=./",
    "TEST_BIGDATA=https://bytesalad.stsci.edu/artifactory",
    "CRDS_SERVER_URL=https://jwst-crds.stsci.edu",
    "CRDS_CONTEXT=jwst_0500.pmap",
]

// Pip related setup
def pip_index = "https://bytesalad.stsci.edu/artifactory/api/pypi/datb-pypi-virtual/simple"
def pip_install_args = "--index-url ${pip_index} --progress-bar=off"

// Pytest command setup
def pytest_basetemp = "test_outputs"
def pytest_command = "pytest -r sx -v \
                      -n 30 \
                      --bigdata --slow \
                      --basetemp=${pytest_basetemp} \
                      --junit-xml=results.xml \
                      jwst/tests_nightly/general"

// Configure artifactory ingest
data_config = new DataConfig()
data_config.server_id = 'bytesalad'
data_config.root = '${pytest_basetemp}'
data_config.match_prefix = '(.*)_result' // .json is appended automatically

bc = new BuildConfig()
bc.nodetype = 'jwst'
bc.env_vars = test_env
bc.conda_packages = ["python=${python_version}"]
bc.build_cmds = [
    "pip install --progress-bar=off numpy==${numpy_version}",
    "pip install ${pip_install_args} .[test]",
    "pip install pytest-xdist",
    "pip freeze",
]

bc.test_cmds = ["${pytest_command}"]

bc.test_configs = [data_config]

utils.run([jobconfig, bc])
